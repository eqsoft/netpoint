#!/bin/sh

## live-config(7) - System Configuration Scripts
## Copyright (C) 2006-2013 Daniel Baumann <daniel@debian.org>
##
## This program comes with ABSOLUTELY NO WARRANTY; for details see COPYING.
## This is free software, and you are welcome to redistribute it
## under certain conditions; see COPYING for details.

set -e

# just a hack for my virtual network nat device
# ToDo: request multiple network devices
if [ "$HOSTNAME" = "host18457464" ]
then
	echo "eth1 detected"
	dhclient eth1
	sleep 5
fi

RTC_KEY=""
RTC_REPO=""
RTC_GRP=""
RTC_HOST=""
RTC_SSH=0

# fake env: 
#HOSTNAME="host18457464"
#RTC_REPO="git@github.com/eqsoft/nprtc"
#RTC_GRP="netpoint"
#RTC_HOST="host18457464"
#RTC_SSH=1

Rtc ()
{
	# Reading kernel command line
	for _PARAMETER in ${_CMDLINE}
	do
		case "${_PARAMETER}" in
			live-config.rtckey=*|rtckey=*)
				RTC_KEY="${_PARAMETER#*rtckey=}"
				;;
			live-config.rtcrepo=*|rtcrepo=*)
				RTC_REPO="${_PARAMETER#*rtcrepo=}"
				;;
			live-config.rtcgrp=*|rtcgrp=*)
				RTC_GRP="${_PARAMETER#*rtcgrp=}"
				;;
			live-config.rtchost|rtchost)
				RTC_HOST="${HOSTNAME}"
				;;
			live-config.rtcssh|rtcssh)
				RTC_SSH=1
				;;
		esac
	done 
	Configure_rtc
}

Configure_rtc ()
{
	echo "Configure_rtc"
	echo "rtckey: ${RTC_KEY}"
	echo "hostname: ${HOSTNAME}"
	echo "rtcrepo: ${RTC_REPO}"
	echo "rtcgrp: ${RTC_GRP}"
	echo "rtchost: ${RTC_HOST}"
	echo "rtcssh: ${RTC_SSH}"
	
	# setting root password
	echo "root:${RTC_KEY}" | chpasswd
	
#	OVERLAY="${LIVE_RTC}/$HOSTNAME/fs_overlay"
#	echo $HOSTNAME
#	svn ls "${OVERLAY}" --depth empty
#	EXISTS=$?
#	# host rtc exits?
#	if [ $EXISTS -ne 0 ]
#	then
#		echo "${OVERLAY} does not exit, trying default host ${DEFAULT_HOST}"
#		OVERLAY="${LIVE_RTC}/$DEFAULT_HOST/fs_overlay"
#		svn ls "${OVERLAY}" --depth empty
#		EXISTS=$?
#		# default host rtc exits?
#		if [ $EXISTS -ne 0 ]
#		then
#			echo "default ${OVERLAY} also does not exit, ignoring live config command."
#			return
#		fi
#	fi
#	echo "try to get rtc..."
#	cd /tmp
#	svn export -q "${OVERLAY}"
#	cp -a fs_overlay/* /
}

Rtc
